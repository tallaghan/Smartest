@{
    ViewBag.Title = "List";
}
<script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
<script src="@Url.Content("~/signalr/hubs")"></script>

<script type="text/javascript">

    // Reference the auto-generated proxy for the hub.
    var rtime = $.connection.realtimeHub;

    $(function () {

        $.ajaxSettings.traditional = true;
        $.ajaxSetup({ cache: false });

        PopulateList();

        // Create a function that the hub can call back
        rtime.client.notifyClients = function (employeeID, fullname, signedIn, signedOn) {
            UpdateEmployee(employeeID, fullname, signedIn, signedOn);
        };

        // Start the connection.
        $.connection.hub.start().done(function () {
        });

    });

    function UpdateEmployee(employeeID, fullname, signedIn, signedOn) {

        var buttonText;
        var lastSignDate = ConvertDateToString(signedOn);
        var currentStatus;
        var linkText = 'javascript:AcceptChallenge(' + employeeID + ');';

        if (signedIn == false) {
            buttonText = 'Sign In';
            currentStatus = 'Signed Out On';
        } else {
            buttonText = 'Sign Out';
            currentStatus = 'Signed In On';
        }

        var divContent = '<p><h2>' + fullname + '</h2>' + currentStatus +

        '<br></br>' + lastSignDate +

        '<br></br><a href="' + linkText + '" class="btn btn-success btn-medium">' + buttonText + ' »</a></p>';

        $("#employee_div_" + employeeID).html(divContent);

        rtime.server.notifyClients(employeeID, fullname, signedIn, signedOn);
    }

    function CreateChallenge(challenger) {

        var actionUrl = "@Url.Action("CreateChallenge", "Game")";

        actionUrl = actionUrl + '/' + employeeID;

        $.ajax({
            cache: false,
            url: actionUrl,
            dataType: "json",
            success: function (data) {
                UpdateEmployee(employeeID, data.FullName, data.LastSigningWasIn, data.LastSigning);
            }
        });
    }

    function PopulateList(empId) {

        $('#challengesDiv').empty();

        var actionUrl = "@Url.Action("GetActiveEmployees", "Home")";

        actionUrl = actionUrl + '/' + empId;

        $.ajax({
            cache: false,
            url: actionUrl,
            dataType: "json",
            success: function (response) {
                var items = response;

                $.each(items, function (index, item) {

                    var lastSigningWasIn = item.LastSigningWasIn;
                    var lastSigningWasToday = item.LastSigningWasToday;
                    var lastSignDate = '';
                    var buttonText;
                    var employeeID = item.EmployeeID;

                    var linkText = 'javascript:CreateSigning(' + employeeID + ');';
                    var currentStatus;

                    if (lastSigningWasIn == null || lastSigningWasIn == false) {
                        lastSigningWasIn = false;
                        buttonText = 'Sign In';
                    } else {
                        if (lastSigningWasToday == true) {
                            buttonText = 'Sign Out';
                        } else {
                            buttonText = 'Sign In';
                        }
                    }

                    if (item.LastSigning != null) {
                        lastSignDate = ConvertDateToString(item.LastSigning);
                        if (lastSigningWasIn == true) {
                            currentStatus = 'Signed In On';
                        } else {
                            currentStatus = 'Signed Out On';
                        }
                    } else {
                        currentStatus = "Never Signed In";
                    }

                    var divToAppend = '<div id="employee_div_' + employeeID + '" class="col-sm-6 col-md-4 col-lg-3">' +

                                    '<p><h2>' + item.FullName + '</h2>' + currentStatus +

                                    '<br></br>' + lastSignDate +

                                    '<br></br><a href="' + linkText + '" class="btn btn-success btn-medium">' + buttonText + ' »</a></p>' +

                                    '</div>';

                    $('#challengesDiv').append(divToAppend);

                });
            }
        });


    }

</script>

<div class="container">
    <div class="jumbotron">
        <h1>Who's The Smartest</h1>
        <p>Accept one of the challenges below or create a new challenge</p>
    </div>
    <div id="challengesDiv" class="row">
    </div>
    <hr>
    <div class="row">
        <div class="col-sm-12">
            <footer>
                <p>© copyright 2015 mtech ltd</p>
            </footer>
        </div>
    </div>
</div>
