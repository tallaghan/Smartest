@{
    ViewBag.Title = "List";
}
<script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
<script src="@Url.Content("~/signalr/hubs")"></script>

<script type="text/javascript">

    // Reference the auto-generated proxy for the hub.
    var rtime = $.connection.realtimeHub;

    $(function () {

        $.ajaxSettings.traditional = true;
        $.ajaxSetup({ cache: false });

        PopulateList();

        // Create a function that the hub can call back
        rtime.client.notifyClients = function (challengeID, fullname, signedIn, signedOn) {
            Updatechallenge(challengeID, fullname, signedIn, signedOn);
        };

        // Start the connection.
        $.connection.hub.start().done(function () {
        });

    });

    function Updatechallenge(challengeID, fullname, signedIn, signedOn) {

        var buttonText;
        var lastSignDate = ConvertDateToString(signedOn);
        var currentStatus;
        var linkText = 'javascript:AcceptChallenge(' + challengeID + ');';

        if (signedIn == false) {
            buttonText = 'Sign In';
            currentStatus = 'Signed Out On';
        } else {
            buttonText = 'Sign Out';
            currentStatus = 'Signed In On';
        }

        var divContent = '<p><h2>' + fullname + '</h2>' + currentStatus +

        '<br></br>' + lastSignDate +

        '<br></br><a href="' + linkText + '" class="btn btn-success btn-medium">' + buttonText + ' »</a></p>';

        $("#challenge_div_" + challengeID).html(divContent);

        rtime.server.notifyClients(challengeID, fullname, signedIn, signedOn);
    }

    function CreateChallenge(challenger) {

        var actionUrl = "@Url.Action("CreateChallenge", "Game")";

        actionUrl = actionUrl + '/' + challengeID;

        $.ajax({
            cache: false,
            url: actionUrl,
            dataType: "json",
            success: function (data) {
                Updatechallenge(challengeID, data.FullName, data.LastSigningWasIn, data.LastSigning);
            }
        });
    }

    function PopulateList(empId) {

        $('#challengesDiv').empty();

        var actionUrl = "@Url.Action("GetActiveChallenges", "Game")";

        $.ajax({
            cache: false,
            url: actionUrl,
            dataType: "json",
            success: function (response) {
                var items = response;

                $.each(items, function (index, item) {

                    var challenger = item.Challenger;
                    var challengeId = item.Id;
                    var buttonText = 'Accept';

                    var linkText = 'javascript:AcceptChallenge(' + challengeId + ');';
                    var currentStatus;

                    var divToAppend = '<div id="challenge_div_' + challengeId + '" class="col-sm-6 col-md-4 col-lg-3">' +

                                    '<p><h2>' + challenger + '</h2>' + 

                                    '<br></br>' + lastSignDate +

                                    '<br></br><a href="' + linkText + '" class="btn btn-success btn-medium">' + buttonText + ' »</a></p>' +

                                    '</div>';

                    $('#challengesDiv').append(divToAppend);

                });
            }
        });


    }

</script>

<div class="container">
    <div class="jumbotron">
        <h1>Who's The Smartest</h1>
        <p>Accept one of the challenges below or create a new challenge</p>
    </div>
    <div id="challengesDiv" class="row">
    </div>
    <hr>
    <div class="row">
        <div class="col-sm-12">
            <footer>
                <p>© copyright 2015 mtech ltd</p>
            </footer>
        </div>
    </div>
</div>
